name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Create proper Briefcase project structure
      run: |
        # Create the expected directory structure
        mkdir -p src/financetracker
        
        # Move main.py to the correct location and rename it
        cp main.py src/financetracker/app.py
        
        # Create __init__.py
        echo '__version__ = "0.0.1"' > src/financetracker/__init__.py
        
        # Create __main__.py
        cat > src/financetracker/__main__.py << 'EOF'
        from financetracker.app import main

        if __name__ == '__main__':
            main()
        EOF

    - name: Create pyproject.toml
      run: |
        cat > pyproject.toml << 'EOF'
        [tool.briefcase]
        project_name = "Finance Tracker"
        bundle = "org.example"
        version = "0.0.1"
        url = "https://github.com/example/finance-tracker"
        author = "Finance App Developer"
        author_email = "developer@example.com"

        [tool.briefcase.app.financetracker]
        formal_name = "Finance Tracker"
        description = "Personal Finance Tracking Application"
        sources = ["src/financetracker"]
        
        [tool.briefcase.app.financetracker.android]
        requires = []
        build_gradle_dependencies = [
            "androidx.appcompat:appcompat:1.6.1",
            "androidx.constraintlayout:constraintlayout:2.1.4",
            "androidx.swiperefreshlayout:swiperefreshlayout:1.1.0",
        ]
        EOF

    - name: Install Briefcase
      run: |
        python -m pip install --upgrade pip
        pip install briefcase

    - name: Build Android APK
      run: |
        briefcase create android
        briefcase build android
        briefcase package android

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: finance-tracker-apk
        path: dist/*.apk
        retention-days: 30
