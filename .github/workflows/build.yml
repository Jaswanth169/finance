name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Create pyproject.toml
      run: |
        cat > pyproject.toml << EOF
        [tool.briefcase]
        project_name = "Finance Tracker"
        bundle = "org.example"
        version = "0.0.1"
        url = "https://github.com/example/finance-tracker"
        license = "MIT"
        author = "Finance App Developer"
        author_email = "developer@example.com"

        [tool.briefcase.app.financetracker]
        formal_name = "Finance Tracker"
        description = "Personal Finance Tracking Application"
        long_description = "A mobile app for tracking personal finances with AI-powered expense categorization"
        sources = ["financetracker"]
        test_sources = ["tests"]

        [tool.briefcase.app.financetracker.android]
        requires = [
            "toga-android~=0.4.0",
        ]
        EOF

    - name: Create app structure
      run: |
        mkdir -p src/financetracker
        cp main.py src/financetracker/app.py
        
        cat > src/financetracker/__init__.py << EOF
        __version__ = "0.0.1"
        EOF

    - name: Install Briefcase
      run: |
        python -m pip install --upgrade pip
        pip install briefcase

    - name: Build Android
      run: |
        briefcase create android
        briefcase build android
        briefcase package android

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: finance-tracker-apk
        path: dist/*.apk
